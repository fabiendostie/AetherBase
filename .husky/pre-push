#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üß™ Running pre-push checks..."

# Run unit tests
echo "üî¨ Running unit tests..."
npm run test:unit || {
  echo "‚ùå Unit tests failed. Fix failing tests before pushing."
  exit 1
}

# Run integration tests
echo "üîó Running integration tests..."
npm run test:integration || {
  echo "‚ùå Integration tests failed. Fix failing tests before pushing."
  exit 1
}

# Check test coverage
echo "üìä Checking test coverage..."
npm run test:coverage || {
  echo "‚ùå Test coverage below threshold (85%). Add more tests."
  exit 1
}

# Verify coverage meets minimum threshold
COVERAGE_THRESHOLD=85
COVERAGE=$(npm run test:coverage:report 2>/dev/null | grep -oP 'All files\s+\|\s+\K[0-9.]+' | head -1)

if [ ! -z "$COVERAGE" ]; then
  COVERAGE_INT=${COVERAGE%.*}
  if [ "$COVERAGE_INT" -lt "$COVERAGE_THRESHOLD" ]; then
    echo "‚ùå Coverage ${COVERAGE}% is below minimum ${COVERAGE_THRESHOLD}%"
    exit 1
  fi
  echo "‚úÖ Coverage: ${COVERAGE}%"
fi

echo "‚úÖ All pre-push checks passed!"
